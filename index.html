<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bright Scholarship - Activity Check-in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <!-- Auth Container -->
    <div id="auth-container" class="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-xl shadow-lg">
        <!-- Login Form -->
        <div id="login-form-container">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-yellow-400">Bright Scholarship</h1>
                <p class="text-gray-300">Awardee Check-in</p>
            </div>
            <form id="login-form" class="space-y-4 mt-6">
                <div>
                    <label for="login-username" class="text-sm font-medium text-gray-300">Username</label>
                    <input type="text" id="login-username" required class="w-full px-4 py-2 mt-1 text-gray-900 bg-gray-200 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
                <div>
                    <label for="login-password" class="text-sm font-medium text-gray-300">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-2 mt-1 text-gray-900 bg-gray-200 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
                <button id="signin-button" type="submit" class="w-full py-2 font-semibold text-white bg-yellow-600 rounded-md hover:bg-yellow-700 transition-colors">Sign In</button>
            </form>
            <p id="login-error" class="text-sm text-center text-red-400 h-4 mt-2"></p>
            <p class="text-sm text-center text-gray-400 mt-4">
                Belum punya akun? <a href="#" id="show-signup-link" class="font-medium text-yellow-400 hover:underline">Daftar di sini</a>
            </p>
        </div>
        <!-- Sign Up Form -->
        <div id="signup-form-container" class="hidden">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-yellow-400">Buat Akun Baru</h1>
                <p class="text-gray-300">Daftarkan akun Anda</p>
            </div>
            <form id="signup-form" class="space-y-4 mt-6">
                <div>
                    <label for="signup-username" class="text-sm font-medium text-gray-300">Username Baru</label>
                    <input type="text" id="signup-username" required class="w-full px-4 py-2 mt-1 text-gray-900 bg-gray-200 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
                <div>
                    <label for="signup-password" class="text-sm font-medium text-gray-300">Password Baru</label>
                    <input type="password" id="signup-password" required class="w-full px-4 py-2 mt-1 text-gray-900 bg-gray-200 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
                <button id="signup-button" type="submit" class="w-full py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">Daftar</button>
            </form>
            <p id="signup-status" class="text-sm text-center h-4 mt-2"></p>
            <p class="text-sm text-center text-gray-400 mt-4">
                Sudah punya akun? <a href="#" id="show-login-link" class="font-medium text-yellow-400 hover:underline">Login di sini</a>
            </p>
        </div>
    </div>

    <!-- Activity Page -->
    <div id="activity-page" class="hidden w-full max-w-4xl p-8 space-y-6 bg-gray-800 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-2xl font-bold text-yellow-400">Daily Activities</h1>
                <p class="text-gray-300">Welcome, <span id="awardee-name" class="font-semibold">Awardee</span>!</p>
            </div>
            <div class="flex gap-2">
                 <button id="reset-button" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">Reset My Activities</button>
                <button id="logout-button" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors">Logout</button>
            </div>
        </div>
        <div id="activity-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </div>

    <!-- Confirmation Modals -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-10">
        <div class="w-full max-w-sm p-6 space-y-4 bg-gray-800 rounded-xl shadow-lg text-center">
            <h2 id="modal-title" class="text-xl font-semibold">Confirm Activity</h2>
            <p id="modal-text">Have you completed the activity: "<span id="modal-activity-name" class="font-bold text-yellow-400"></span>"?</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel-button" class="px-6 py-2 font-semibold text-white bg-gray-600 rounded-md hover:bg-gray-700 transition-colors">Cancel</button>
                <button id="modal-confirm-button" class="px-6 py-2 font-semibold text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors">Done</button>
            </div>
            <p id="modal-status" class="text-sm text-blue-400 h-4"></p>
        </div>
    </div>

    <!-- Google API Script -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script type="module">
        const GOOGLE_CLIENT_ID = '658332040904-q4n09rpmp74gkoik168jt2ejv6ef11cr.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1r0ymBQyxJlQpqK3eIpa7Lak62M3gLCEl0uC_mavKjP0';
        const ACTIVITY_SHEET_NAME = 'Sheet1';
        const USER_SHEET_NAME = 'Pengguna';
        const MONTHLY_DATA_SHEET_NAME = 'monthly data';
        const CONFIG_SHEET_NAME = 'Config';

        const ACTIVITIES = [
            "Mandi Subuh", "Tahajjud", "kemasjid Sebelum Adzan Subuh", "Dzuhur Berjamaah",
            "Ashar Berjamaah", "Magrib Berjamaah", "Isya Berjamaah",
            "Al-Ma'atsurat", "Murāja‘ah", "Tasmi", "Syuruq", "Dhuha", "Puasa Sunnah"
        ];

        // All page elements...
        const authContainer = document.getElementById('auth-container');
        const loginFormContainer = document.getElementById('login-form-container');
        const signupFormContainer = document.getElementById('signup-form-container');
        const showSignupLink = document.getElementById('show-signup-link');
        const showLoginLink = document.getElementById('show-login-link');
        const activityPage = document.getElementById('activity-page');
        const signinButton = document.getElementById('signin-button');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const signupForm = document.getElementById('signup-form');
        const signupButton = document.getElementById('signup-button');
        const signupStatus = document.getElementById('signup-status');
        const awardeeNameSpan = document.getElementById('awardee-name');
        const logoutButton = document.getElementById('logout-button');
        const resetButton = document.getElementById('reset-button');
        const activityGrid = document.getElementById('activity-grid');
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalActivityName = document.getElementById('modal-activity-name');
        const modalCancelButton = document.getElementById('modal-cancel-button');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const modalStatus = document.getElementById('modal-status');

        let tokenClient;
        let selectedActivity = null;
        let loggedInUsername = null;
        let currentAction = null;

        function gapiInit() {
            gapi.client.init({}).then(() => gapi.client.load('sheets', 'v4'));
        }

        function gisInit() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: '',
            });
        }

        async function handleAuth() {
            return new Promise((resolve, reject) => {
                if (gapi.client.getToken() !== null) return resolve();
                tokenClient.callback = (resp) => {
                    if (resp.error !== undefined) return reject(resp);
                    resolve();
                };
                tokenClient.requestAccessToken({ prompt: 'consent' });
            });
        }
        
        showSignupLink.addEventListener('click', (e) => { e.preventDefault(); loginFormContainer.classList.add('hidden'); signupFormContainer.classList.remove('hidden'); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); signupFormContainer.classList.add('hidden'); loginFormContainer.classList.remove('hidden'); });
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const usernameInput = document.getElementById('login-username').value;
            const passwordInput = document.getElementById('login-password').value;
            loginError.textContent = '';
            signinButton.disabled = true;
            signinButton.textContent = 'Signing In...';

            try {
                await handleAuth();
                await checkForDailyReset(); // Check for reset upon login

                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID, range: `${USER_SHEET_NAME}!A:B`,
                });
                
                const userList = response.result.values || [];
                const foundUser = userList.find(row => row[0] && row[1] && row[0].trim().toLowerCase() === usernameInput.trim().toLowerCase() && row[1].trim() === passwordInput.trim());

                if (foundUser) {
                    loggedInUsername = foundUser[0];
                    awardeeNameSpan.textContent = loggedInUsername;
                    authContainer.classList.add('hidden');
                    activityPage.classList.remove('hidden');
                    populateActivityGrid();
                } else {
                    loginError.textContent = "Invalid username or password.";
                }
            } catch (error) {
                console.error("Login process failed:", error);
                loginError.textContent = "An error occurred. Please try again.";
            } finally {
                signinButton.disabled = false;
                signinButton.textContent = 'Sign In';
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const password = document.getElementById('signup-password').value.trim();
            signupStatus.textContent = '';
            signupButton.disabled = true;
            signupButton.textContent = 'Registering...';

            if (!username || !password) {
                signupStatus.textContent = 'Username and password cannot be empty.';
                signupStatus.className = 'text-sm text-center text-red-400 h-4 mt-2';
                signupButton.disabled = false;
                signupButton.textContent = 'Daftar';
                return;
            }

            try {
                await handleAuth();
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID, range: `${USER_SHEET_NAME}!A:A`,
                });
                const userList = (response.result.values || []).flat();
                const userExists = userList.some(u => u.trim().toLowerCase() === username.toLowerCase());

                if (userExists) {
                    signupStatus.textContent = 'Username already taken.';
                    signupStatus.className = 'text-sm text-center text-red-400 h-4 mt-2';
                } else {
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: SPREADSHEET_ID, range: `${USER_SHEET_NAME}!A:B`,
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [[username, password]] },
                    });
                    signupStatus.textContent = 'Account created! Please log in.';
                    signupStatus.className = 'text-sm text-center text-green-400 h-4 mt-2';
                    signupForm.reset();
                    setTimeout(() => showLoginLink.click(), 2000);
                }
            } catch (error) {
                console.error("Signup failed:", error);
                signupStatus.textContent = 'An error occurred during sign up.';
                signupStatus.className = 'text-sm text-center text-red-400 h-4 mt-2';
            } finally {
                signupButton.disabled = false;
                signupButton.textContent = 'Daftar';
            }
        });
        
        logoutButton.addEventListener('click', () => {
            loggedInUsername = null;
            if (gapi.client.getToken() !== null) {
                google.accounts.oauth2.revoke(gapi.client.getToken().access_token, () => {});
                gapi.client.setToken('');
            }
            activityPage.classList.add('hidden');
            authContainer.classList.remove('hidden');
            loginForm.reset();
        });

        resetButton.addEventListener('click', () => {
            currentAction = 'reset';
            modalTitle.textContent = 'Confirm Reset';
            modalText.innerHTML = 'Are you sure you want to reset all of your activities to "0"?';
            modalConfirmButton.textContent = 'Yes, Reset';
            modalConfirmButton.className = 'px-6 py-2 font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors';
            modalStatus.textContent = '';
            modal.classList.remove('hidden');
        });

        modalCancelButton.addEventListener('click', () => modal.classList.add('hidden'));

        modalConfirmButton.addEventListener('click', async () => {
            modalStatus.textContent = 'Processing...';
            modalConfirmButton.disabled = true;
            try {
                if (currentAction === 'update') {
                    await updateSheet(selectedActivity, '1');
                    modalStatus.textContent = 'Success!';
                    const card = document.querySelector(`[data-activity="${selectedActivity}"]`);
                    if(card) {
                        card.classList.add('bg-green-800', 'cursor-not-allowed');
                        card.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                        card.onclick = null;
                    }
                } else if (currentAction === 'reset') {
                    await resetUserActivities();
                    modalStatus.textContent = 'Your activities have been reset!';
                    populateActivityGrid();
                }
                setTimeout(() => modal.classList.add('hidden'), 1500);
            } catch (error) {
                console.error("Action failed:", error);
                modalStatus.textContent = 'An error occurred.';
            } finally {
                modalConfirmButton.disabled = false;
            }
        });

        function populateActivityGrid() {
            activityGrid.innerHTML = '';
            ACTIVITIES.forEach(activity => {
                const card = document.createElement('div');
                card.className = 'p-4 bg-gray-700 rounded-lg text-center cursor-pointer hover:bg-gray-600 transition-colors flex items-center justify-center';
                card.textContent = activity;
                card.dataset.activity = activity;
                card.onclick = () => {
                    currentAction = 'update';
                    selectedActivity = activity;
                    modalTitle.textContent = 'Confirm Activity';
                    modalText.innerHTML = `Have you completed the activity: "<span class="font-bold text-yellow-400">${activity}</span>"?`;
                    modalConfirmButton.textContent = 'Done';
                    modalConfirmButton.className = 'px-6 py-2 font-semibold text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors';
                    modalStatus.textContent = '';
                    modal.classList.remove('hidden');
                };
                activityGrid.appendChild(card);
            });
        }

        async function updateSheet(activityName, value) {
            if (!loggedInUsername) throw new Error("User not logged in.");
            const headers = (await gapi.client.sheets.spreadsheets.values.get({spreadsheetId: SPREADSHEET_ID, range: `${ACTIVITY_SHEET_NAME}!1:1`})).result.values[0];
            const awardeeColumnIndex = headers.findIndex(header => header.trim().toLowerCase() === loggedInUsername.toLowerCase());
            if (awardeeColumnIndex === -1) throw new Error(`Column for awardee "${loggedInUsername}" not found.`);
            const awardeeColumnLetter = String.fromCharCode('A'.charCodeAt(0) + awardeeColumnIndex);
            const activityColumn = (await gapi.client.sheets.spreadsheets.values.get({spreadsheetId: SPREADSHEET_ID, range: `${ACTIVITY_SHEET_NAME}!A:A`})).result.values.flat();
            const activityRowIndex = activityColumn.findIndex(cell => cell.trim().toLowerCase() === activityName.toLowerCase());
            if (activityRowIndex === -1) throw new Error(`Row for activity "${activityName}" not found.`);
            const cellToUpdate = `${ACTIVITY_SHEET_NAME}!${awardeeColumnLetter}${activityRowIndex + 1}`;
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID, range: cellToUpdate, valueInputOption: 'USER_ENTERED', resource: { values: [[value]] },
            });
        }

        async function resetUserActivities() {
            if (!loggedInUsername) throw new Error("User not logged in.");
            const headers = (await gapi.client.sheets.spreadsheets.values.get({spreadsheetId: SPREADSHEET_ID, range: `${ACTIVITY_SHEET_NAME}!1:1`})).result.values[0];
            const awardeeColumnIndex = headers.findIndex(header => header.trim().toLowerCase() === loggedInUsername.toLowerCase());
            if (awardeeColumnIndex === -1) throw new Error(`Column for awardee "${loggedInUsername}" not found.`);
            const awardeeColumnLetter = String.fromCharCode('A'.charCodeAt(0) + awardeeColumnIndex);
            const valuesToUpdate = ACTIVITIES.map(() => ["0"]);
            const rangeToUpdate = `${ACTIVITY_SHEET_NAME}!${awardeeColumnLetter}2:${awardeeColumnLetter}${ACTIVITIES.length + 1}`;
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID, range: rangeToUpdate, valueInputOption: 'USER_ENTERED', resource: { values: valuesToUpdate }
            });
        }

        async function checkForDailyReset() {
            const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD format
            const lastResetDateResponse = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID, range: `${CONFIG_SHEET_NAME}!A1`,
            });
            const lastResetDate = lastResetDateResponse.result.values?.[0]?.[0];

            if (lastResetDate !== today) {
                console.log("New day detected. Starting daily reset and logging process...");
                signinButton.textContent = 'Running Daily Reset...';
                await logDataToMonthlySheet(lastResetDate || today);
                await autoResetAllActivities();
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID, range: `${CONFIG_SHEET_NAME}!A1`,
                    valueInputOption: 'USER_ENTERED', resource: { values: [[today]] },
                });
                console.log("Daily reset and logging complete.");
            }
        }

        async function logDataToMonthlySheet(logDate) {
            const activityDataResponse = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID, range: ACTIVITY_SHEET_NAME,
            });
            const allData = activityDataResponse.result.values;
            const headers = allData[0];
            const activityRows = allData.slice(1);
            const scores = headers.slice(1).map((header, index) => {
                return activityRows.reduce((sum, row) => sum + (parseInt(row[index + 1]) || 0), 0);
            });
            const newLogRow = [logDate, ...scores];
            await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: SPREADSHEET_ID, range: `${MONTHLY_DATA_SHEET_NAME}!A1`,
                valueInputOption: 'USER_ENTERED', resource: { values: [newLogRow] },
            });
        }

        async function autoResetAllActivities() {
            const headers = (await gapi.client.sheets.spreadsheets.values.get({spreadsheetId: SPREADSHEET_ID, range: `${ACTIVITY_SHEET_NAME}!1:1`})).result.values[0];
            const numColumns = headers.length - 1;
            const numRows = ACTIVITIES.length;
            const resetData = Array(numRows).fill(0).map(() => Array(numColumns).fill('0'));
            const rangeToClear = `${ACTIVITY_SHEET_NAME}!B2:${String.fromCharCode('A'.charCodeAt(0) + numColumns)}${numRows + 1}`;
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID, range: rangeToClear,
                valueInputOption: 'USER_ENTERED', resource: { values: resetData },
            });
        }

        window.onload = () => { gapi.load('client', gapiInit); gisInit(); };
    </script>
</body>
</html>
